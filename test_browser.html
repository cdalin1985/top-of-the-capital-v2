<!doctype html>
<html>
  <head>
    <title>Analytics Dashboard Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
      }
      .test-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }
      .success {
        background-color: #d4edda;
        border-color: #c3e6cb;
      }
      .error {
        background-color: #f8d7da;
        border-color: #f5c6cb;
      }
      .info {
        background-color: #d1ecf1;
        border-color: #bee5eb;
      }
      button {
        padding: 10px 15px;
        margin: 5px;
        cursor: pointer;
      }
      input {
        padding: 8px;
        margin: 5px;
      }
      pre {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 3px;
        overflow-x: auto;
      }
      iframe {
        width: 100%;
        height: 600px;
        border: 1px solid #ccc;
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <h1>üéØ Capital Ladder Analytics Dashboard Test</h1>

    <div class="test-section info">
      <h3>Dashboard Integration Test</h3>
      <p>This page tests the analytics dashboard integration with the Capital Ladder app.</p>

      <div>
        <button onclick="testLogin()">1. Test Login</button>
        <button onclick="testAnalyticsAPI()">2. Test Analytics API</button>
        <button onclick="openAnalyticsDashboard()">3. Open Analytics Dashboard</button>
        <button onclick="openMainApp()">4. Open Main App</button>
      </div>

      <div id="test-results" style="margin-top: 15px"></div>
    </div>

    <div class="test-section">
      <h3>Analytics Dashboard Preview</h3>
      <p>Direct view of the analytics dashboard:</p>
      <iframe src="http://localhost:3001/analytics.html" id="analyticsFrame"></iframe>
    </div>

    <script>
      function log(message, type = 'info') {
        const results = document.getElementById('test-results');
        const div = document.createElement('div');
        div.className = `test-section ${type}`;
        div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
        results.appendChild(div);
        results.scrollTop = results.scrollHeight;
      }

      async function testLogin() {
        log('üîê Testing user registration/login...', 'info');

        try {
          const response = await fetch('http://localhost:3001/api/auth/register', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              email: 'dashboard.test@example.com',
              password: 'testpass123',
              displayName: 'Dashboard Tester'
            })
          });

          const data = await response.json();

          if (data.token) {
            log('‚úÖ User registered successfully! Token received.', 'success');
            localStorage.setItem('test_token', data.token);
            log(`üìß Login credentials: dashboard.test@example.com / testpass123`, 'info');
          } else if (data.message && data.message.includes('User already exists')) {
            log('‚ÑπÔ∏è User already exists. Attempting login...', 'info');
            await attemptLogin();
          } else {
            log(`‚ùå Registration failed: ${data.message || 'Unknown error'}`, 'error');
          }
        } catch (error) {
          log(`‚ùå Registration error: ${error.message}`, 'error');
        }
      }

      async function attemptLogin() {
        try {
          const response = await fetch('http://localhost:3001/api/auth/login', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              email: 'dashboard.test@example.com',
              password: 'testpass123'
            })
          });

          const data = await response.json();

          if (data.token) {
            log('‚úÖ Login successful! Token received.', 'success');
            localStorage.setItem('test_token', data.token);
          } else {
            log(`‚ùå Login failed: ${data.message || 'Invalid credentials'}`, 'error');
          }
        } catch (error) {
          log(`‚ùå Login error: ${error.message}`, 'error');
        }
      }

      async function testAnalyticsAPI() {
        const token = localStorage.getItem('test_token');

        if (!token) {
          log('‚ùå No authentication token. Please login first.', 'error');
          return;
        }

        log('üìä Testing analytics API endpoints...', 'info');

        try {
          const response = await fetch(
            'http://localhost:3001/api/analytics/overview/metrics?period=30d',
            {
              headers: {
                Authorization: `Bearer ${token}`
              }
            }
          );

          const data = await response.json();

          if (data.success) {
            log('‚úÖ Analytics API working! Data received.', 'success');
            log(`<pre>${JSON.stringify(data.data, null, 2)}</pre>`, 'success');
          } else {
            log(`‚ùå Analytics API failed: ${data.error || 'Unknown error'}`, 'error');
          }
        } catch (error) {
          log(`‚ùå Analytics API error: ${error.message}`, 'error');
        }
      }

      function openAnalyticsDashboard() {
        log('üöÄ Opening analytics dashboard in new window...', 'info');
        window.open('http://localhost:3001/analytics.html', '_blank');
      }

      function openMainApp() {
        log('üè† Opening main app in new window...', 'info');
        window.open('http://localhost:3001', '_blank');
      }

      // Auto-run initial test
      window.addEventListener('load', () => {
        log('üéØ Analytics Dashboard Test Suite Ready', 'info');
        log('üìã Steps to test:', 'info');
        log('1. Click "Test Login" to create/login test user', 'info');
        log('2. Click "Test Analytics API" to verify backend integration', 'info');
        log('3. Click "Open Analytics Dashboard" to test standalone dashboard', 'info');
        log('4. Click "Open Main App" to test full app integration', 'info');
        log(
          '5. In main app, login with credentials shown above and click Analytics button',
          'info'
        );
      });
    </script>
  </body>
</html>
